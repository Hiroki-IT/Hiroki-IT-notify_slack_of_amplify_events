service: notify-slack-of-amplify-events

frameworkVersion: '2'

# 変数
custom:
  env: dev
  service: notify-slack-of-amplify-events

# プロバイダー
provider:
  name: aws
  region: ap-northeast-1
  stackName: ${self:custom.env}-${self:custom.service}-stack
  stage: ${self:custom.env}

# デプロイ対象のパッケージ
package:
  patterns:
    - ./bin/**

# Lambda
functions:
  main: 
    description: The function that notify slack of amplify events
    events:
      - eventBridge:
          pattern: ${file(./serverless_configs/events/amplify_event.json)}
    image: baseImage
    lambdaHashingVersion: 20201221
    maximumRetryAttempts: 1
    memorySize: 512    
    name: ${self:custom.env}-${self:custom.service}
    role: !GetAtt LambdaRole.Arn
    runtime: go1.x  

# ECR
ecr:
  scanOnPush: true
  images:
    baseImage:
      uri: ${env:AWS_ECR_ACCOUNT_URL}/${env:AWS_ECR_REPOSITORY}@${env:CIRCLE_SHA1}

# 追加AWSリソース
resources:
  Resources:
    LambdaRole:
      Type: AWS::IAM::Role
      Properties:
        RoleName: ${self:custom.env}-${self:custom.service}-lambda-role
        Description: The role for ${self:custom.env}-${self:custom.service}-lambda
        AssumeRolePolicyDocument: ${file(./serverless_configs/policies/trust_policies/lambda_policy.json)}
        # インラインポリシー
        Policies:
          - PolicyName: ${self:custom.env}-${self:custom.service}-lambda-execution-policy
            PolicyDocument: ${file(./serverless_configs/policies/custom_managed_policies/lambda_execution_policy.json)}
        # 管理ポリシー
        ManagedPolicyArns:
          - arn:aws:iam::aws:policy/AWSLambdaExecute    
          
